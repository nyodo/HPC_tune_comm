# MT-3000 天津超算连接机制说明

## 🔍 关键发现

通过分析代码，发现了后端连接天津超算 MT-3000 的完整机制：

---

## 📋 连接架构

### 代码分析

**关键文件**：`visualtool-backend/api/mt3000_connect.py`

```python
class Mt3000Client:
    def __init__(
        self,
        hostname: str,           # 超算地址：192.168.10.20
        username: str,           # 超算用户名：xjtu_cx
        password: str,            # 超算密码
        proxy_host: str = "127.0.0.1",  # SOCKS5 代理地址
        proxy_port: int = 1080,   # SOCKS5 代理端口（EasyConnect 默认）
        ssh_port: int = 22,
    ):
        # 通过 SOCKS5 代理建立 SSH 连接
        self._proxy_sock = socks.socksocket()
        self._proxy_sock.set_proxy(socks.SOCKS5, self.proxy_host, self.proxy_port)
        self._proxy_sock.connect((self.hostname, self.ssh_port))
```

**配置文件**：`visualtool-backend/mt3000/config.json`

```json
{
  "mt3000_client": {
    "hostname": "192.168.10.20",      // 天津超算地址
    "username": "xjtu_cx",            // 超算用户名
    "password": "gCWyS6RmwEAT",        // 超算密码
    "proxy_host": "127.0.0.1",        // SOCKS5 代理地址
    "proxy_port": 1080,               // EasyConnect SOCKS5 代理端口
    "ssh_port": 22
  }
}
```

---

## 🔗 连接流程

### 完整连接链路

```
┌─────────────────────────────────────────────────────────────┐
│  前端 (你的本地电脑)                                           │
│  - 已通过 EasyConnect 连接 XJTU 内网                          │
│  - EasyConnect 在本地建立 SOCKS5 代理：127.0.0.1:1080        │
└─────────────────────────────────────────────────────────────┘
                    │
                    │ HTTP 请求
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  后端服务器 (10.181.142.180)                                  │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  Flask 应用运行在这里                                  │   │
│  │  当需要连接 MT-3000 时：                               │   │
│  │  1. 创建 Mt3000Client                                 │   │
│  │  2. 尝试连接 127.0.0.1:1080 (SOCKS5 代理)             │   │
│  │  3. 通过代理连接 192.168.10.20:22 (天津超算)          │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                    │
                    │ ❌ 问题：服务器上没有 SOCKS5 代理！
                    │    127.0.0.1:1080 在服务器上不存在
                    ▼
┌─────────────────────────────────────────────────────────────┐
│  天津超算 MT-3000 (192.168.10.20)                           │
│  - 只能通过 XJTU 内网访问                                     │
│  - 需要 SOCKS5 代理才能连接                                   │
└─────────────────────────────────────────────────────────────┘
```

---

## ⚠️ 问题分析

### 核心问题

**后端代码期望在运行环境中找到 SOCKS5 代理（127.0.0.1:1080），但实际情况是：**

1. **如果后端运行在本地**：
   - ✅ EasyConnect 在本地建立了 SOCKS5 代理（127.0.0.1:1080）
   - ✅ 后端可以直接通过代理连接超算
   - ✅ **这是可行的！**

2. **如果后端运行在服务器上（10.181.142.180）**：
   - ❌ 服务器上没有 EasyConnect
   - ❌ 服务器上没有 SOCKS5 代理（127.0.0.1:1080）
   - ❌ 后端无法连接超算
   - ❌ **这是不可行的！**

---

## ✅ 解决方案

### 方案一：后端运行在本地（推荐用于开发）

**架构**：
```
你的本地电脑
  ├─ EasyConnect (SOCKS5 代理: 127.0.0.1:1080)
  ├─ 后端 Flask (127.0.0.1:8108)
  └─ 前端 (127.0.0.1:8080)
       │
       │ 通过 SSH 隧道
       ▼
  服务器 (10.181.142.180)
       └─ 数据库 MySQL
```

**步骤**：

1. **确保 EasyConnect 已连接 XJTU 内网**
   ```powershell
   # 检查 EasyConnect 是否运行
   # 应该能看到 SOCKS5 代理在 127.0.0.1:1080
   ```

2. **在本地运行后端**
   ```powershell
   cd visualtool-backend
   conda activate accessmemory
   python app.py
   ```

3. **通过 SSH 隧道连接服务器数据库**
   ```powershell
   # 如果需要连接服务器上的数据库
   ssh -J z135 -L 3307:127.0.0.1:3306 -p 1022 ls@10.181.142.180
   ```

4. **修改后端数据库配置**（如果需要）
   ```python
   # app.py
   SQLALCHEMY_DATABASE_URI = "mysql+pymysql://root:123456@127.0.0.1:3307/visualtool"
   ```

5. **启动前端**
   ```powershell
   cd vis
   npm run dev
   ```

**优点**：
- ✅ 后端可以直接使用本地的 EasyConnect SOCKS5 代理
- ✅ 连接超算没有问题
- ✅ 适合开发和测试

**缺点**：
- ❌ 需要本地运行后端
- ❌ 本地电脑关机后服务停止

---

### 方案二：在服务器上运行 EasyConnect（如果可能）

**如果服务器支持运行 EasyConnect**：

1. **在服务器上安装并运行 EasyConnect**
   ```bash
   # 通过 SSH 连接到服务器
   ssh -J z135 -p 1022 ls@10.181.142.180
   
   # 在服务器上运行 EasyConnect（如果支持）
   # 这样服务器上也会有 SOCKS5 代理 127.0.0.1:1080
   ```

2. **后端在服务器上运行**
   ```bash
   cd ~/visualtool-backend
   conda activate accessmemory
   python app.py
   ```

**优点**：
- ✅ 后端在服务器上 24/7 运行
- ✅ 可以直接使用服务器上的 SOCKS5 代理

**缺点**：
- ❌ 服务器可能不支持运行 EasyConnect（Linux 服务器通常不支持）
- ❌ 需要图形界面或特殊配置

---

### 方案三：SSH 隧道转发 SOCKS5 代理（推荐用于生产）

**将本地的 SOCKS5 代理通过 SSH 隧道转发到服务器**

**架构**：
```
你的本地电脑
  ├─ EasyConnect (SOCKS5: 127.0.0.1:1080)
  └─ SSH 隧道转发
       │
       │ 转发 SOCKS5 代理到服务器
       ▼
  服务器 (10.181.142.180)
  ├─ 后端 Flask
  └─ 通过转发的代理连接超算
```

**步骤**：

1. **建立 SSH 隧道，转发 SOCKS5 代理**
   ```powershell
   # 将本地的 SOCKS5 代理转发到服务器
   ssh -J z135 -R 1080:127.0.0.1:1080 -p 1022 ls@10.181.142.180
   
   # 或者使用动态端口转发
   ssh -J z135 -D 1080 -p 1022 ls@10.181.142.180
   ```

2. **在服务器上运行后端**
   ```bash
   cd ~/visualtool-backend
   conda activate accessmemory
   python app.py
   ```

3. **修改服务器上的配置文件**
   ```json
   // mt3000/config.json
   {
     "mt3000_client": {
       "proxy_host": "127.0.0.1",  // 服务器上的转发代理
       "proxy_port": 1080
     }
   }
   ```

**优点**：
- ✅ 后端在服务器上运行
- ✅ 可以使用本地的 EasyConnect 代理

**缺点**：
- ⚠️ 需要保持 SSH 隧道连接
- ⚠️ 配置相对复杂

---

### 方案四：使用 SSH 动态端口转发（最简单）

**使用 SSH 的动态端口转发功能，在服务器上创建 SOCKS5 代理**

**步骤**：

1. **在本地建立 SSH 动态端口转发**
   ```powershell
   # 通过跳板机，在服务器上创建 SOCKS5 代理
   # 这个代理会通过你的本地 EasyConnect 连接超算
   ssh -J z135 -D 1080 -p 1022 ls@10.181.142.180 -N
   
   # -D 1080: 在服务器上创建 SOCKS5 代理（端口 1080）
   # -N: 不执行远程命令，只建立隧道
   ```

2. **在服务器上运行后端**
   ```bash
   cd ~/visualtool-backend
   conda activate accessmemory
   python app.py
   ```

3. **后端配置保持不变**
   ```json
   // mt3000/config.json
   {
     "mt3000_client": {
       "proxy_host": "127.0.0.1",  // 服务器上的 SOCKS5 代理
       "proxy_port": 1080
     }
   }
   ```

**工作原理**：
- SSH 动态端口转发在服务器上创建了一个 SOCKS5 代理
- 这个代理会通过 SSH 隧道连接到你的本地
- 你的本地通过 EasyConnect 连接到 XJTU 内网
- 最终实现：服务器 → SSH 隧道 → 你的本地 → EasyConnect → XJTU 内网 → 天津超算

**优点**：
- ✅ 配置简单
- ✅ 后端在服务器上运行
- ✅ 自动通过你的本地 EasyConnect

**缺点**：
- ⚠️ 需要保持 SSH 隧道连接

---

## 🎯 推荐方案

### 开发环境
**使用方案一**：后端运行在本地
- 简单直接
- 易于调试
- 适合个人开发

### 生产环境
**使用方案四**：SSH 动态端口转发
- 后端在服务器上运行
- 通过 SSH 隧道使用本地的 EasyConnect
- 配置相对简单

---

## 📝 配置步骤总结

### 开发环境配置

1. **确保 EasyConnect 已连接**
   - 连接到 `sslvpn.xjtu.edu.cn`
   - 确认 SOCKS5 代理在 `127.0.0.1:1080`

2. **在本地运行后端**
   ```powershell
   cd visualtool-backend
   conda activate accessmemory
   python app.py
   ```

3. **启动前端**
   ```powershell
   cd vis
   npm run dev
   ```

### 生产环境配置

1. **建立 SSH 动态端口转发**
   ```powershell
   ssh -J z135 -D 1080 -p 1022 ls@10.181.142.180 -N
   # 保持窗口打开
   ```

2. **在服务器上运行后端**
   ```bash
   ssh -J z135 -p 1022 ls@10.181.142.180
   cd ~/visualtool-backend
   conda activate accessmemory
   python app.py
   ```

---

## 🔍 验证连接

### 检查 SOCKS5 代理

**在本地**：
```powershell
# 检查本地是否有 SOCKS5 代理
netstat -an | findstr 1080
```

**在服务器上**（如果使用方案四）：
```bash
# 检查服务器上的 SOCKS5 代理
netstat -tuln | grep 1080
```

### 测试 MT-3000 连接

后端代码会在需要时自动连接，可以通过日志查看：

```python
# 查看后端日志
# 应该能看到连接超算的信息
```

---

## ❓ 常见问题

### Q1: 为什么后端需要 SOCKS5 代理？

**A**: 天津超算 MT-3000 (192.168.10.20) 只能通过 XJTU 内网访问，而 EasyConnect 提供了 SOCKS5 代理来访问内网资源。

### Q2: 后端运行在哪里？

**A**: 
- **开发时**：运行在本地（你的电脑）
- **生产时**：运行在服务器上，但需要通过 SSH 隧道使用本地的 EasyConnect

### Q3: 如果服务器上也有 EasyConnect 怎么办？

**A**: 如果服务器支持运行 EasyConnect，可以直接在服务器上运行，后端配置 `proxy_host: "127.0.0.1"` 即可。

### Q4: 如何确认 EasyConnect 的 SOCKS5 代理端口？

**A**: 
- 默认是 `1080`
- 可以在 EasyConnect 设置中查看
- 或使用 `netstat -an | findstr 1080` 检查

---

## 📚 相关文件

- `visualtool-backend/api/mt3000_connect.py` - MT-3000 连接客户端
- `visualtool-backend/mt3000/config.json` - MT-3000 配置
- `visualtool-backend/mt3000/collection/io/io_collection.py` - IO 数据采集
- `visualtool-backend/mt3000/optimization/compute/compute_optimization.py` - 计算优化

---

## 总结

**关键点**：
1. 后端通过 **SOCKS5 代理**（127.0.0.1:1080）连接天津超算
2. 这个代理由 **EasyConnect** 提供
3. **开发时**：后端运行在本地，直接使用本地代理 ✅
4. **生产时**：后端运行在服务器，需要通过 SSH 隧道使用本地代理 ✅

**推荐**：
- 开发：后端本地运行
- 生产：使用 SSH 动态端口转发（方案四）
