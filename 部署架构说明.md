# 部署架构说明：前端、后端、数据库部署位置

## 📋 目录
1. [服务器信息说明](#服务器信息说明)
2. [部署架构方案](#部署架构方案)
3. [推荐部署方案](#推荐部署方案)
4. [详细部署步骤](#详细部署步骤)

---

## 服务器信息说明

### 实验室 GPU 服务器信息

```
IP 地址：10.181.142.180
SSH 端口：1022
用户名：ls
密码：camel
```

**这是什么？**
- 这是一台**远程服务器**（实验室的 2080Ti GPU 服务器）
- 通过 **SSH** 协议可以远程连接
- 通常用于：
  - 运行需要 GPU 的计算任务
  - 部署后端服务（供团队访问）
  - 运行数据库服务
  - 模型训练和推理

**如何连接？**
```powershell
ssh -p 1022 ls@10.181.142.180
# 输入密码：camel
```

---

## 部署架构方案

### 方案对比

| 组件 | 本地开发 | 服务器部署 | 说明 |
|------|---------|-----------|------|
| **前端** | ✅ 本地 (127.0.0.1:8080) | ⚠️ 可选 | 开发时本地，生产可部署到服务器或 CDN |
| **后端** | ✅ 本地 (127.0.0.1:8108) | ✅ **推荐** | 开发可本地，生产建议部署到服务器 |
| **数据库** | ✅ 本地 (127.0.0.1:3306) | ✅ **推荐** | 开发可本地，生产建议部署到服务器 |

---

## 推荐部署方案

### 🎯 方案一：开发环境（本地开发）

**适用场景**：个人开发、调试、学习

```
┌─────────────────────────────────────────┐
│          你的本地电脑                      │
│  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  前端     │  │  后端     │  │  数据库  │ │
│  │ 8080端口  │  │ 8108端口  │  │ 3306端口 │ │
│  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────┘
```

**优点**：
- ✅ 快速启动，无需网络
- ✅ 调试方便
- ✅ 适合个人开发

**缺点**：
- ❌ 只能本机访问
- ❌ 关机后服务停止
- ❌ 不适合团队协作

---

### 🎯 方案二：生产环境（服务器部署）⭐ 推荐

**适用场景**：团队使用、正式环境、需要 GPU 计算

```
┌─────────────────────────────────────────┐
│      你的本地电脑（开发/访问）              │
│  ┌──────────┐                            │
│  │  前端     │  → 通过浏览器访问服务器      │
│  │ (可选)    │                            │
│  └──────────┘                            │
└─────────────────────────────────────────┘
                    │
                    │ HTTP/HTTPS
                    ▼
┌─────────────────────────────────────────┐
│    实验室服务器 (10.181.142.180)          │
│  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  前端     │  │  后端     │  │  数据库  │ │
│  │ (Nginx)   │  │ 8108端口  │  │ 3306端口 │ │
│  │ 或静态文件 │  │ Flask     │  │ MySQL   │ │
│  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────┘
```

**优点**：
- ✅ 团队可访问
- ✅ 24/7 运行
- ✅ 可使用 GPU 资源
- ✅ 统一管理

**缺点**：
- ⚠️ 需要服务器配置
- ⚠️ 需要网络连接

---

### 🎯 方案三：混合部署（推荐用于开发）

**适用场景**：本地开发，服务器运行后端和数据库

```
┌─────────────────────────────────────────┐
│          你的本地电脑                    │
│  ┌──────────┐                           │
│  │  前端     │  → 通过代理访问服务器后端   │
│  │ 8080端口  │                           │
│  └──────────┘                           │
└─────────────────────────────────────────┘
                    │
                    │ SSH 隧道 / 内网
                    ▼
┌─────────────────────────────────────────┐
│    实验室服务器 (10.181.142.180)          │
│  ┌──────────┐  ┌──────────┐             │
│  │  后端     │  │  数据库    │             │
│  │ 8108端口  │  │ 3306端口   │             │
│  └──────────┘  └──────────┘             │
└─────────────────────────────────────────┘
```

**优点**：
- ✅ 前端本地开发，热更新快
- ✅ 后端和数据库在服务器，可共享
- ✅ 适合团队协作开发

---

## 详细部署步骤

### 🚀 方案一：本地开发环境部署

#### 1. 数据库部署（本地）

**步骤**：
```powershell
# 1. 安装 MySQL（如果还没安装）
# 下载：https://dev.mysql.com/downloads/mysql/

# 2. 启动 MySQL 服务
# Windows: 在服务管理器中启动 MySQL 服务

# 3. 创建数据库
mysql -u root -p
CREATE DATABASE visualtool CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
EXIT;
```

**配置**：
- 地址：`127.0.0.1:3306`
- 用户：`root`
- 密码：`123456`
- 数据库：`visualtool`

#### 2. 后端部署（本地）

**步骤**：
```powershell
cd visualtool-backend

# 激活 conda 环境
conda activate accessmemory

# 启动后端
python app.py
```

**访问**：
- 地址：`http://127.0.0.1:8108`
- 自动创建管理员账号：`admin/admin`

#### 3. 前端部署（本地）

**步骤**：
```powershell
cd vis

# 安装依赖（首次）
npm install

# 启动开发服务器
npm run dev
```

**访问**：
- 地址：`http://127.0.0.1:8080`
- 自动代理后端：`/api/*` → `http://127.0.0.1:8108/*`

---

### 🚀 方案二：服务器生产环境部署

#### 1. 连接到服务器

```powershell
ssh -p 1022 ls@10.181.142.180
# 输入密码：camel
```

#### 2. 上传代码到服务器

**方法 A：使用 SCP**
```powershell
# 在本地 PowerShell 执行
scp -P 1022 -r visualtool-backend ls@10.181.142.180:~/
scp -P 1022 -r vis ls@10.181.142.180:~/
```

**方法 B：使用 Git**
```bash
# 在服务器上执行
cd ~
git clone <你的仓库地址>
cd HPC-Visual-Tuning-Modeling-Platform
```

#### 3. 在服务器上部署数据库

```bash
# 连接到服务器后
# 1. 安装 MySQL（如果还没安装）
sudo apt update
sudo apt install mysql-server

# 2. 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 3. 配置 MySQL
sudo mysql_secure_installation

# 4. 创建数据库
mysql -u root -p
CREATE DATABASE visualtool CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'root'@'localhost' IDENTIFIED BY '123456';
GRANT ALL PRIVILEGES ON visualtool.* TO 'root'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

#### 4. 在服务器上部署后端

```bash
# 1. 进入后端目录
cd ~/visualtool-backend  # 或你的代码路径

# 2. 创建 conda 环境（如果还没有）
conda env create -f environment.yml
conda activate accessmemory  # 或 LS（根据服务器环境名）

# 3. 修改数据库配置（如果需要）
# 编辑 app.py，确保数据库连接正确
# SQLALCHEMY_DATABASE_URI = "mysql://root:123456@127.0.0.1:3306/visualtool"

# 4. 使用 screen 或 nohup 后台运行
screen -S backend
python app.py
# 按 Ctrl+A 然后 D 分离会话

# 或者使用 nohup
nohup python app.py > app.log 2>&1 &

# 5. 检查是否运行
ps aux | grep python
netstat -tuln | grep 8108
```

#### 5. 在服务器上部署前端

**选项 A：使用 Nginx 部署（推荐）**

```bash
# 1. 安装 Nginx
sudo apt install nginx

# 2. 构建前端
cd ~/vis
npm install
npm run build  # 生成 dist 目录

# 3. 配置 Nginx
sudo nano /etc/nginx/sites-available/visualtool

# 添加配置：
server {
    listen 80;
    server_name 10.181.142.180;  # 或你的域名
    
    # 前端静态文件
    location / {
        root /home/ls/vis/dist;
        try_files $uri $uri/ /index.html;
    }
    
    # 后端 API 代理
    location /api {
        proxy_pass http://127.0.0.1:8108;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}

# 4. 启用配置
sudo ln -s /etc/nginx/sites-available/visualtool /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

**选项 B：使用 Vite 生产服务器（简单但不推荐）**

```bash
# 1. 构建前端
cd ~/vis
npm install
npm run build

# 2. 使用 Vite 预览（仅测试用）
npm run preview -- --host 0.0.0.0 --port 8080
```

#### 6. 配置防火墙

```bash
# 开放端口
sudo ufw allow 80      # HTTP
sudo ufw allow 443     # HTTPS（如果使用）
sudo ufw allow 8108    # 后端（如果直接访问）
sudo ufw allow 22      # SSH
sudo ufw enable
```

#### 7. 访问应用

- **前端**: `http://10.181.142.180` (通过 Nginx)
- **后端 API**: `http://10.181.142.180/api/*` (通过 Nginx 代理)
- **或直接访问后端**: `http://10.181.142.180:8108` (如果开放了端口)

---

### 🚀 方案三：混合部署（开发推荐）

#### 1. 服务器端：部署后端和数据库

按照**方案二**的步骤 3 和 4，在服务器上部署数据库和后端。

#### 2. 本地：运行前端开发服务器

```powershell
cd vis

# 修改 vite.config.js，将代理目标改为服务器地址
# target: "http://10.181.142.180:8108"

npm run dev
```

**修改 `vis/vite.config.js`**：
```javascript
proxy: {
  "/api": {
    target: "http://10.181.142.180:8108",  // 改为服务器地址
    changeOrigin: true,
    rewrite: (path) => path.replace(/^\/api/, ""),
  },
}
```

#### 3. 使用 SSH 隧道（如果服务器在内网）

如果服务器在内网，需要通过 SSH 隧道访问：

```powershell
# 建立 SSH 隧道
ssh -L 8108:127.0.0.1:8108 -p 1022 ls@10.181.142.180

# 保持窗口打开，然后修改 vite.config.js
# target: "http://127.0.0.1:8108"
```

---

## 部署方案选择建议

### 个人开发学习
✅ **方案一：本地部署**
- 所有组件都在本地
- 快速启动，无需网络
- 适合学习和调试

### 团队协作开发
✅ **方案三：混合部署**
- 前端本地开发（热更新快）
- 后端和数据库在服务器（共享资源）
- 适合多人协作

### 生产环境
✅ **方案二：服务器部署**
- 所有组件在服务器
- 24/7 运行
- 团队可访问
- 可使用 GPU 资源

---

## 部署检查清单

### 本地部署检查
- [ ] MySQL 已安装并运行
- [ ] 数据库 `visualtool` 已创建
- [ ] 后端服务运行在 8108 端口
- [ ] 前端服务运行在 8080 端口
- [ ] 可以访问 `http://127.0.0.1:8080`

### 服务器部署检查
- [ ] 可以 SSH 连接到服务器
- [ ] MySQL 已安装并运行
- [ ] 数据库 `visualtool` 已创建
- [ ] 后端代码已上传到服务器
- [ ] Conda 环境已创建
- [ ] 后端服务正在运行（检查进程）
- [ ] 前端已构建并部署（Nginx 或静态服务器）
- [ ] 防火墙端口已开放
- [ ] 可以从外部访问

---

## 常见问题

### Q1: 前端应该部署在哪里？
**A**: 
- **开发环境**：本地运行 `npm run dev`，方便调试
- **生产环境**：构建后部署到服务器 Nginx，或使用 CDN

### Q2: 后端应该部署在哪里？
**A**: 
- **开发环境**：本地运行，快速迭代
- **生产环境**：**强烈推荐部署到服务器**，因为：
  - 需要 24/7 运行
  - 团队可访问
  - 可使用 GPU 资源（模型训练/推理）

### Q3: 数据库应该部署在哪里？
**A**: 
- **开发环境**：本地 MySQL，方便调试
- **生产环境**：**推荐部署到服务器**，与后端同机或独立数据库服务器

### Q4: 如何选择部署方案？
**A**: 
- **个人学习** → 方案一（本地）
- **团队开发** → 方案三（混合）
- **正式上线** → 方案二（服务器）

### Q5: 服务器在内网怎么办？
**A**: 
- 使用 SSH 隧道连接
- 或配置 VPN
- 或使用内网穿透工具（如 frp、ngrok）

---

## 总结

### 推荐部署架构

```
┌─────────────────────────────────────────┐
│    开发环境（本地）                        │
│  - 前端：本地开发服务器                    │
│  - 后端：本地或通过 SSH 隧道连接服务器      │
└─────────────────────────────────────────┘
                    │
                    │ 开发完成后
                    ▼
┌─────────────────────────────────────────┐
│    生产环境（服务器 10.181.142.180）       │
│  ┌──────────┐  ┌──────────┐  ┌─────────┐ │
│  │  前端     │  │  后端     │  │  数据库  │ │
│  │ (Nginx)   │  │ (Flask)   │  │ (MySQL) │ │
│  └──────────┘  └──────────┘  └─────────┘ │
└─────────────────────────────────────────┘
```

**关键点**：
1. **开发时**：前端本地，后端和数据库可在服务器
2. **生产时**：全部部署到服务器，通过 Nginx 统一访问
3. **服务器优势**：GPU 资源、24/7 运行、团队共享
